import torch
import numpy as np
from tqdm import tqdm

MODEL = 'c4'
agents_mask_path = './inspection/masks/train_full_agents_fut_10_his_10.npz'
agents_labels_path = './inspection/labels_3.0/labels_full_fut_10_fix_3.0.pt'

labels_10_90 = [246, 155, 123, 390, 214, 536, 250, 364, 314, 416, 129, 158, 59, 463, 198, 41, 590, 136, 318, 563, 142, 595, 28, 194, 264, 555, 489, 86, 341, 294, 164, 367, 178, 230, 269, 414, 447, 383, 287, 161, 195, 554, 267, 607, 185, 93, 604, 110, 154, 624, 337, 239, 424, 578, 179, 448, 169, 556, 215, 591, 238, 119, 441, 472, 192, 516, 120, 485, 95, 551, 68, 31, 402, 80, 150, 470, 438, 245, 144, 163, 258, 42, 188, 121, 282, 98, 524, 56, 104, 561, 138, 526, 75, 151, 58, 428, 196, 64, 380, 412, 483, 61, 152, 614, 13, 112, 102, 156, 435, 257, 522, 488, 393, 50, 99, 236, 117, 584, 302, 290, 545, 293, 532, 273, 616, 212, 291, 486, 124, 77, 170, 384, 288, 84, 481, 20, 297, 206, 528, 571, 83, 107, 504, 249, 92, 347, 515, 617, 497, 85, 208, 487, 325, 222, 391, 247, 276, 105, 176, 512, 81, 172, 231, 207, 507, 506, 69, 2, 541, 200, 473, 111, 201, 539, 168, 126, 114, 467, 459, 453, 491, 392, 355, 109, 224, 243, 190, 220, 320, 182, 397, 167, 518, 574, 197, 181, 145, 533, 450, 339, 90, 410, 299, 24, 35, 227, 330, 289, 482, 292, 157, 317, 279, 635, 162, 631, 254, 240, 598, 609, 244, 559, 577, 275, 298, 445, 542, 354, 513, 456, 305, 307, 256, 411, 434, 363, 262, 371, 592, 265, 565, 57, 552, 263, 328, 210, 549, 209, 237, 583, 375, 498, 405, 191, 368, 557, 296, 266, 492, 147, 409, 44, 633, 413, 106, 309, 523, 576, 268, 344, 350, 323, 603, 627, 306, 322, 621, 232, 300, 139, 62, 419, 619, 457, 281, 573, 387, 218, 233, 399, 88, 469, 226, 427, 395, 362, 295, 417, 495, 628, 567, 285, 394, 562, 582, 398, 175, 477, 272, 327, 454, 73, 378, 465, 613, 148, 432, 505, 251, 601, 550, 331, 431, 228, 316, 311, 440, 396, 543, 283, 476, 468, 301, 74, 183, 205, 304, 620, 135, 89, 425, 452, 484, 586, 475, 502, 319, 315, 366, 159, 229, 365, 118, 357, 490, 618, 436, 408, 177, 131, 400, 570, 234, 534, 376, 253, 40, 535, 321, 538, 100, 580, 382, 271, 418, 203, 374, 579, 449, 544, 546, 605, 25, 329, 622, 422, 149, 500, 259, 348, 356, 377, 527, 248, 359, 186, 589, 478, 588, 202, 221, 433, 278, 353, 508, 461, 358, 407, 548, 493, 361, 204, 379, 599, 564, 173, 596, 429, 442, 560, 217, 349, 437, 415, 385, 189, 569, 352, 160, 602, 370, 342, 199, 514, 632, 336, 494, 517, 388, 510, 313, 462, 585, 310, 537, 312, 566, 389, 553, 466, 67, 625, 480, 406, 277, 439, 332, 219, 587, 401, 386, 430, 460, 558, 630, 525, 324, 593, 455, 184, 496, 501, 520, 303, 133, 193, 369, 531, 503, 338, 530, 610, 568, 360, 597, 626, 629, 308, 608, 471, 223, 474, 634, 404, 242, 521, 420, 511, 581, 612, 137, 423, 426, 78, 529, 252, 351, 82]
labels_5_95 =  [99, 236, 117, 584, 302, 290, 545, 293, 532, 273, 616, 212, 291, 486, 124, 77, 170, 384, 288, 84, 481, 20, 297, 206, 528, 571, 83, 107, 504, 249, 92, 347, 515, 617, 497, 85, 208, 487, 325, 222, 391, 247, 276, 105, 176, 512, 81, 172, 231, 207, 507, 506, 69, 2, 541, 200, 473, 111, 201, 539, 168, 126, 114, 467, 459, 453, 491, 392, 355, 109, 224, 243, 190, 220, 320, 182, 397, 167, 518, 574, 197, 181, 145, 533, 450, 339, 90, 410, 299, 24, 35, 227, 330, 289, 482, 292, 157, 317, 279, 635, 162, 631, 254, 240, 598, 609, 244, 559, 577, 275, 298, 445, 542, 354, 513, 456, 305, 307, 256, 411, 434, 363, 262, 371, 592, 265, 565, 57, 552, 263, 328, 210, 549, 209, 237, 583, 375, 498, 405, 191, 368, 557, 296, 266, 492, 147, 409, 44, 633, 413, 106, 309, 523, 576, 268, 344, 350, 323, 603, 627, 306, 322, 621, 232, 300, 139, 62, 419, 619, 457, 281, 573, 387, 218, 233, 399, 88, 469, 226, 427, 395, 362, 295, 417, 495, 628, 567, 285, 394, 562, 582, 398, 175, 477, 272, 327, 454, 73, 378, 465, 613, 148, 432, 505, 251, 601, 550, 331, 431, 228, 316, 311, 440, 396, 543, 283, 476, 468, 301, 74, 183, 205, 304, 620, 135, 89, 425, 452, 484, 586, 475, 502, 319, 315, 366, 159, 229, 365, 118, 357, 490, 618, 436, 408, 177, 131, 400, 570, 234, 534, 376, 253, 40, 535, 321, 538, 100, 580, 382, 271, 418, 203, 374, 579, 449, 544, 546, 605, 25, 329, 622, 422, 149, 500, 259, 348, 356, 377, 527, 248, 359, 186, 589, 478, 588, 202, 221, 433, 278, 353, 508, 461, 358, 407, 548, 493, 361, 204, 379, 599, 564, 173, 596, 429, 442, 560, 217, 349, 437, 415, 385, 189, 569, 352, 160, 602, 370, 342, 199, 514, 632, 336, 494, 517, 388, 510, 313, 462, 585, 310, 537, 312, 566, 389, 553, 466, 67, 625, 480, 406, 277, 439, 332, 219, 587, 401, 386, 430, 460, 558, 630, 525, 324, 593, 455, 184, 496, 501, 520, 303, 133, 193, 369, 531, 503, 338, 530, 610, 568, 360, 597, 626, 629, 308, 608, 471, 223, 474, 634, 404, 242, 521, 420, 511, 581, 612, 137, 423, 426, 78, 529, 252, 351, 82]
tough_labels = [448, 228, 336, 621, 533, 40, 406, 342, 139, 203, 352, 254, 133, 173, 449, 545, 348, 478, 183, 250, 515, 585, 569, 538, 635, 546, 424, 539, 557, 325, 472, 570, 283, 302, 419, 299, 391, 331, 276, 493, 44, 273, 627, 407, 592, 466, 414, 305, 431, 186, 506, 290, 452, 337, 363, 322, 49, 85, 600, 555, 361, 97, 323, 224, 582, 605, 339, 409, 380, 319, 101, 362, 280, 390, 469, 602, 460, 162, 150, 536, 392, 168, 558, 559, 468, 232, 301, 489, 505, 454, 535, 63, 365, 156, 69, 56, 422, 378, 632, 37, 159, 395, 408, 573, 461, 103, 467, 401, 74, 590, 425, 402, 288, 154, 245, 297, 99, 88, 258, 599, 271, 20, 207, 165, 221, 92, 35, 387, 182, 587, 269, 185, 379, 111, 490, 31, 201, 215, 486, 508, 320, 181, 149, 197, 527, 102, 462, 94, 104, 62, 123, 619, 298, 157, 158, 105, 93, 75, 246, 227, 212, 492, 216, 226, 25, 144, 189, 622, 393, 566, 512, 522, 285, 588, 119, 397, 513, 96, 81, 237, 55, 117, 584, 364, 432, 206, 200, 222, 394, 550, 524, 272, 247, 578, 504, 167, 64, 523, 618, 71, 230, 267, 306, 367, 357, 187, 80, 614, 372, 289, 388, 48, 87, 196, 623, 135, 411, 318, 345, 398, 121, 33, 86, 28, 98, 410, 620, 210, 540, 451, 403, 417, 488, 382, 413, 169, 317, 292, 126, 155, 34, 354, 633, 202, 465, 152, 41, 542, 263, 50, 211, 79, 315, 236, 275, 311, 287, 471, 563, 437, 447, 239, 148, 483, 130, 463, 153, 389, 572, 399, 9, 435, 8, 45, 544, 27, 457, 428, 1, 549, 248, 300, 235]

print(f'There are {len(labels_10_90)} 10:90 rare labels and {len(tough_labels)} tough labels.')

rare_labels = np.intersect1d(np.array(labels_10_90), np.array(tough_labels))
print(f'The intersection gives {len(rare_labels)} labels.')
rare_labels_trick = { lab: True for lab in rare_labels}

labels = torch.load(agents_labels_path)
agents_mask = np.load(agents_mask_path)['arr_0']
mask_indices = np.argwhere(agents_mask).flatten()
new_mask_slice = np.zeros(len(mask_indices))

print(len(labels), np.sum(agents_mask), len(agents_mask))
assert len(labels) == np.sum(agents_mask), 'number of labels is inconsistent with mask'

for idx, mask_idx in tqdm(enumerate(mask_indices)):
    label = labels[idx].item()
    try:
        rare_labels_trick[label]
        new_mask_slice[idx] = 1
    except:
        pass

new_mask_slice = new_mask_slice.astype(bool)
agents_mask[mask_indices] = new_mask_slice
print(f'Found {np.sum(agents_mask)} rare examples.')

np.savez(f'./inspection/masks/full_rare_labels_mask_{MODEL}.npz', agents_mask.astype(bool))

